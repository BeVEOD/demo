<%;################################################
## This file and all its content belong to Faveod S.A.S unless a commercial
## contract signed by a representant of Faveod S.A.S states otherwise.
##########
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
################################################
## This has been generated by Faveod Generator on Thu Oct 15 01:21:17 +0200 2009
## It should be placed at 'app/views/users/importer.html.erb'
## All manual modifications will be destroyed on next generation
################################################ 
-%>
<h2 class="title"><%= _("Importing %{records}") % {:records => _("Users")} %> </h2>

<div id="thread_status"><%= render :partial => 'importer_threads'  %></div>

<p class="help"><%= _(%q{Import data from CSV and XLS files in 4 easy steps}) %></p>

<% form_tag('/users/importer', :multipart => true, :id => 'import_form') do %>
  <div id='data_source'><%= render :partial => 'importer_data_source' %></div>
  <div id='preview'><%= render :partial => 'importer_preview'  %></div>
  <div id='results'><%= render :partial => 'importer_results'  %></div>
<% end %>

<div class='overlay_dark'   id='darken' style='display:none'></div>
<div class='overlay_text' id='importer_loading' style="display:none">
  <%= _(%q{Processing...}) %> <%= _(%q{Please wait}) %><br />
  <img style="align:center" src="/images/std/indicator.gif" />
</div>



<script type="text/javascript">
//<![CDATA[


function refresh_importer() {

  $('importer_loading').show(); $('darken').show();
  new Ajax.Request('/users/importer',
     {onFailure: function(fail) {
        setup_importer_observers('.source_options');
	$('users_indicator').setStyle({fontSize:'larger',color:'red'});
	$('users_indicator').innerHTML = 'Error: server error';
        },
      parameters: $('import_form').serialize()})

  $$('.source_options').map(function(e) {
    e.disable(); e.stopObserving('change', refresh_importer) })
  
}

function refresh_thread_status() {

  new Ajax.Request("<%= url_for(:action => 'importer', :thread => {:action => :percent}) %>")

}

function setup_importer_observers(selector) {

  $('importer_loading').hide(); $('darken').hide();
  $$('.command_button').map(function (x) {x.disable()});
  $$(selector).map(function(e) { e.observe("change", refresh_importer); e.enable(); })

}

function onload_importer_call() {
setInterval("refresh_thread_status()", 5000)
}
<% if request.xhr? %>onload_importer_call();<% else %>Event.observe(window, 'load', onload_importer_call);<% end %>
//]]>
</script>